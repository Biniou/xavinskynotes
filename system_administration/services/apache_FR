######
APACHE
######

.. contents:: Sommaire

Installation
------------

::

    aptitude install apache2 apache2-mpm-worker apache2-utils libapache2-mod-proxy-html
    aptitude install openssl ssl-cert


Les modules
-----------

Pour connaitre les modules compilés avec apaches ::

    apache -l 

Liste des modes apache enable ::

    ls /etc/apache2/mods-enabled

    cgid.conf
    cgid.load
    dav_fs.conf
    dav_fs.load
    dav.load
    dav_svn.conf
    dav_svn.load
    proxy_html.load
    proxy.load
    rewrite.load
    ssl.conf
    ssl.load
    userdir.conf
    userdir.load


Les Ports
---------

Fichier de configuration modifié /etc/apache2/port.conf pour chaque port
ouvert ::

    Listen 80
    Listen 443


Debian et apache
----------------

Modification debian sur la disposition des fichiers apaches ::

    binaries (apachectl)  /usr/sbin/
    gestionnaire de demon /etc/init.d/apache2 (start|stop|graceful|configtest)
    ServerRoot            /etc/apache2/
    Fichier de config     /etc/apache2/apache2.conf
    Modules  disponible   /etc/apache2/mods-available/
    Module active         /etc/apache2/mods-enabled/
    VHost disponible      /etc/apache2/sites-available/
    VHost activé          /etc/apache2/sites-enabled/

    VHost par Default     /etc/apache2/sites-available/default, /etc/apache2/sites-enabled/000-default
    son DocumentRoot      /var/www/
    son ErrorLog          /var/log/apache2/error.log
    son AccessLog         /var/log/apache2/access.log
    son cgi-bin           /usr/lib/cgi-bin/


HTTPS
=====

Generer les certificats pour le https

Autosigne
---------

Version certificat SSL autosigné avec password ::

    openssl req -x509 -newkey rsa:1024 -out new.cert.cert -keyout cert.key -days 365
    # (IMPORTANT uniquement repondre le caractere '*' a la question
    # Common Name (eg, YOUR name) []:*
    # Enlever le mot de passe de la cle (necessaire pour https) :
    openssl rsa -in cert.key -out new.cert.key
    # detruire les fichiers temportaires et placer le tout dans /etc/apache2/ssl
    rm cert.key
    mkdir /etc/apache2/ssl
    mv new.cert.key /etc/apache2/ssl
    mv new.cert.cert /etc/apache2/ssl
    # changer le droit de fichier pour des questions de securité :
    chmod 700 /etc/apache2/ssl/*
    # redemarrer l'apache2 :
    /etc/init.d/apache2 restart

Startssl
--------

Version certificat signé par startsll.com ::

    # Creation cle privé RSA (Triple-DES / PEM)
    # avec une phrase pass.
    openssl genrsa -des3 -out server.key 1024 
    # On elimine ensuite la phrase pass :
    openssl rsa -in server.key -out server.key2
    # On crée la requête de certificat
    openssl req -new -key server.key2 -out server.csr
    # (IMPORTANT mettre le domaine ou l'IP (* est payant) )
    # Common Name (eg, YOUR name) []: 123.13.12.23
    # (IMPORTANT donner une adresse email valide)
    # Email Address []: votreadresse@domaine.com
    # (IMPORTANT retenir le challenge)
    # A challenge password [] : aretenir
    # Afficher le certificat pour la requete sur startsll.com
    # cat server.csr

    # Faire signer son certificat par startcom.
    # Aller sur : https://cert.startcom.org/?lang=fr
    # puis cliquer sur
    # Assistant de Création de Certificat
    # <https://cert.startcom.org/?app=101&lang=fr>
    # choisir classe 1 puis continuer.
    # choisir Server Certificate (Without CSR generation) puis continuer
    # Remplir Personal Registration Details:
    # Donner ensuite le certificat.

    # Un mail sera envoyé au choix à
    # webmaster@IPorDomain
    # hostmaster@IPorDomain
    # postmaster@IPorDomain

    # on recoit un code de verification
    # que l'on utilise dans le formulaire suivant.
    # pour l'instant pas de serveur de mail
    # de configurer... donc la suite un autre jour.

    # On fini avec deux fichiers
    # que l'on rajoute dans la config apache :

    SSLCertificateFile    /path/to/this/server.crt2
    SSLCertificateKeyFile /path/to/this/server.key2

    # The server.csr file is no longer needed.

Documentation apache sur les générations de certificats
<http://httpd.apache.org/docs/2.2/ssl/ssl_faq.html>





Config zope zwook
=================

Fichiers de configuration des sites dans /etc/apache2/sites-available

avec ::

    mon domaine : mon.domaine.org
    port du site http : 80
    port du site https : 443
    mon email : webmaster@mon.email.org
    Repertoire ou son stoquer mes images :  /var/www/zwo_images
    Port de mon zope : 8080

ressemble a ceci, /etc/apache2/sites-available/mon.domaine.org :: 

    NameVirtualHost *:80
    <VirtualHost *:80>
      DocumentRoot /var/www
      ServerName mon.domaine.org
      ServerAdmin webmaster@mon.email.org
      RewriteEngine On
      RewriteRule ^/(.*)zwo_images(.*) /var/www/zwo_images$2 [L]
      RewriteRule ^/(.*) http://localhost:8080/VirtualHostBase/http/mon.domaine.org:80/forlderzope/zwook/VirtualHostRoot/$1 [L,P]
    </VirtualHost>

    <VirtualHost *:443>
      ServerName mon.domaine.org:443
      ServerAdmin webmaster@mon.email.org
      SSLEngine on
      SSLCertificateFile /etc/apache2/ssl/new.cert.cert
      SSLCertificateKeyFile /etc/apache2/ssl/new.cert.key
      RewriteEngine On
      RewriteRule ^/(.*)zwo_images(.*) /var/zope/1et0/Products/Zwook/zwo_images$2 [L]
      RewriteRule ^/(.*) http://localhost:8080/VirtualHostBase/https/mon.domaine.org:443/forlderzope/zwook/VirtualHostRoot/$1 [L,P]
    </VirtualHost>

faire un lien symbolique de ce ficher dans site-enable

ln -s /etc/apache2/sites-available/mon.domaine.org /etc/apache2/sites-enable/mon.domaine.org

